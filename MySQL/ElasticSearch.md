# 第五节：ElasticSearch

### 基础

ES不是数据库，它适合于海量数据、更新频率很低的数据(ES没有事务也不适合处理并行更改数据)，创建文档后，es不支持更新域（字段类型）。
ES是全文搜索引擎，能够对中文进行全文搜索，处理同义词和根据相关性给文档打分；能根据同一份数据生成分析和聚合的结果；在没有大量工作进程（线程）的情况下能做到对数据的实时处理。
#### 集群
集群这个概念从业务层面来看，是聚合了某方面功能的节点的组合，一般由单个或多个节点组成。在ES中，具有相同的cluster.name的节点就为同一个集群， 一个集群就是由一个或多个拥有相同cluster.name的节点组成。
#### 节点
一个运行中的ES实例被成为一个节点，一个或多个节点（ES实例）则组成一个集群。
每个集群中会有主节点，ES会自动进行主节点选举，对用户透明。主节点的主要职责是管理集群范围內的数据变更，包括索引的增加／删除 ，节点的增加／删除，监控节点的状态等，它的工作负荷相对其他节点而言较轻，当集群流量增加时，它不会成为瓶颈。从节点负责具体的细节变更，比如文档级别的变更或搜索。各个节点能均匀地分摊集群的负载，实现负载均衡，以及数据冗余备份，当某个节点因为硬件故障丢失数据时，其他节点存放的冗余数据可以保证整个集群的数据完整性。
#### 分片
分片是一个底层的工作单元每个分片都是一个Lucene实例，每个Lucene实例都是一个独立的搜索引擎每个分片只存放索引全部数据中的一部分；
分片是节点中存储数据的核心单元，每个索引的文档数据是均匀地存放到多个分片中的（默认为5个），每个分片只能存储20亿个文档；
分片有主分片和副本分片的区别，索引的内容均匀地放到各个主分片中，每个文档都属于某一个主分片；副本分片是主分片的冗余拷贝，和对应的主分片有完全一样的数据；主分片的数量在索引建立时会被定死，副本分片的数量没有限制，副本分片越多，集群的规模会相应的扩大，海量的检索请求会分散到各个副本上，系统的吞吐量会有成倍的提升。

总结一下，一个集群是由一个或多个节点（ES实例）组成，一个节点又是由一个或多个分片（Lucene实例）组成。

### 坑
#### 分页
ES默认的分页机制一个不足的地方是，比如有5010条数据，当你仅想取第5000到5010条数据的时候，ES也会将前5000条数据加载到内存当中，ES为了避免用户的过大分页请求造成ES服务所在机器内存溢出，默认对深度分页的条数进行了限制，默认的最大条数是10000条。
解决方案1：
修改配置，调整的新的窗口数：
```
curl -XPUT http://127.0.0.1:9200/my_index/_settings -d '{ "index" : { "max_result_window" : 500000}}'。
```
缺点：窗口值调大了后，虽然请求到分页的数据条数更多了，但它是用牺牲更多的服务器的内存、CPU资源来换取的。
解决方案2：
https://www.elastic.co/guide/en/elasticsearch/reference/5.6/search-request-search-after.html，利用search_after参数
scroll查询原理是在第一次查询的时候一次性生成一个快照，根据上一次的查询的id来进行下一次的查询，这个就类似于关系型数据库的游标，然后每次滑动都是根据产生的游标id进行下一次查询，这种性能比上面说的分页性能要高出很多，基本都是毫秒级的。
缺点：不支持跨页查询
解决方案3：
每次查询超过10000万条记录的时候，都会去更新一次index。
缺点：慢

### 版本更新

ES从5.X就引入了text和keyword，其中keyword用于不分词字段，搜索时只能完全匹配；到了6.X就彻底移除string了，“index”的值就只能是boolean变量了。
